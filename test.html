<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript" src="./js/cdstorage.js"></script>
  <script type="text/javascript" src="./js/jsonp.js"></script>
</head>
<body>
<h1>Persistency test!</h1>
<div id="result">
Checking...
</div>

<script type="text/javascript">

// Feature test
var hasStorage = (function() {
  try {
    localStorage.setItem("somekey", "somevalue");
    localStorage.removeItem("somekey");
    return true;
  } catch (exception) {
    return false;
  }
}());

var hasSessionStorage = (function() {
  try {
    sessionStorage.setItem("somekey", "somevalue");
    sessionStorage.removeItem("somekey");
    return true;
  } catch (exception) {
    return false;
  }
}());

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
}

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
}

function visitCounter() {
    if (hasStorage) {
        if (localStorage.visitCounter) {
            localStorage.visitCounter = Number(localStorage.visitCounter)+1;
        } else {
            localStorage.visitCounter = 1;
        }
		return localStorage.visitCounter;
	}
}

function sessionVisitCounter() {
    if (hasSessionStorage) {
        if (sessionStorage.visitCounter) {
            sessionStorage.visitCounter = Number(sessionStorage.visitCounter)+1;
        } else {
            sessionStorage.visitCounter = 1;
        }
		return sessionStorage.visitCounter;
	} else {
		return "no session storage";
	}
}


function cookieVisitCounter() {
	var cVisitCount = getCookie("visits");
	var counter;
	if (cVisitCount != null && cVisitCount != "") {
		counter = Number(cVisitCount) + 1;
	} else {
		counter = 1;
	}
	setCookie("visits", counter, 365);
	return counter;
}

function writeText(text) {
	var element = document.getElementById("result");
	var newHTML = element.innerHTML + "<br/>" + text;
	element.innerHTML = newHTML;
}

if (hasStorage) {
	writeText("Local storage is supported.");
	var visits = visitCounter();
	writeText("According the Local Storage you visited <span style='font-size:120%;font-weight:bold'>" + visits + " time(s)</span>");
	window.contextStorage = new CDStorage("", "");
	window.contextStorage.init();
	contextStorage.onCacheReady().then(function () {
		writeText("Checking 3rd party storage...");
		setTimeout (function() {
			var iframe_visit_counter = contextStorage.getItem("visit_count");
				if (iframe_visit_counter) {
					iframe_visit_counter = Number(iframe_visit_counter)+1;
			} else {
				iframe_visit_counter = 1;
			}
			contextStorage.setItem("visit_count", iframe_visit_counter, true )
			writeText("According to 3rd party storage you have visited <span style='font-size:120%;font-weight:bold'>" + iframe_visit_counter + " time(s)</span>");
			window.cdStorageDone = true;
			if (window.thirdPartyCookieDone && window.cdStorageDone) {
				writeText("Done.");
			}
		},1200);
	});
} else {
	writeText("No Local storage support found!");
	window.cdStorageDone = true;
	if (window.thirdPartyCookieDone && window.cdStorageDone) {
		writeText("Done.");
	}
}

writeText("checking Session Storage support...");
if (hasSessionStorage) {
	var sessionVisits = sessionVisitCounter();
	writeText("According to Session Storage you visited <span style='font-size:120%;font-weight:bold'>" + sessionVisits + " time(s)</span>");
} else {
	writeText("No session storage support found!");
}

writeText("Checking cookies...");
var cvisits = cookieVisitCounter();
writeText("According to Cookies you have visited <span style='font-size:120%;font-weight:bold'>" + cvisits + " time(s)</span>");

writeText("Checking 3rd party cookies...");
window.visitCounter = null;
window.responseHandler = function(counterJSON) {
	window.visitCounter = counterJSON.count; 
}
window.outputResponse = function() {
	clearTimeout(t1);
	if (typeof window.visitCounter) {
		writeText("According to 3rd party cookie you have visited <span style='font-size:120%;font-weight:bold'>" + window.visitCounter + " time(s)</span>")
	} else {
		writeText("<span style='font-size:120%;font-weight:bold'>" + "Invalid response from cookie server :(</span>");
	}
	window.thirdPartyCookieDone = true;
}
var url = window.location.href
var arr = url.split("/");

add_script(arr[0] + '//cdn.commercesciences.com/cookie-counter?cachecontrol=' + Math.random(),window.outputResponse);
var t1 = setTimeout(function() {
	writeText("<span style='font-size:120%;font-weight:bold'>" + "No response from cookie server. If this continues text Eyal.B 054-5454550</span>");
	window.thirdPartyCookieDone = true;
	if (window.thirdPartyCookieDone && window.cdStorageDone) {
		writeText("Done.");
	}
},5000);


</script>



</body>
</html>
